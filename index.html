<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SFT.iBT v8.0 | Architect</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* CSS RE-ENGINEERED FOR SCALABILITY & LIQUID GLASS */
        :root {
            --bg: #000000;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --gold: #D4AF37; --silver: #C0C0C0; --red: #FF3B30; --green: #34C759;
            --font: 'SF Mono', 'Menlo', monospace;
        }

        body {
            background: var(--bg); color: #fff; font-family: var(--font);
            margin: 0; padding: 15px 15px 140px 15px; -webkit-font-smoothing: antialiased;
        }

        .glass-panel {
            background: var(--glass); backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            border: 1px solid var(--glass-border); border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin-bottom: 12px;
        }

        /* DYNAMIC HUD GRID */
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0; overflow: hidden; }
        .hud-cell { padding: 15px; text-align: center; border-bottom: 1px solid var(--glass-border); border-right: 1px solid var(--glass-border); }
        .hud-cell:nth-child(2n) { border-right: none; }
        .hud-cell.full { grid-column: span 2; border-right: none; }
        
        .stat-label { font-size: 0.55rem; color: var(--silver); text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.6; margin-bottom: 4px; }
        .stat-val { font-size: 1.1rem; font-weight: bold; }
        .gold { color: var(--gold); } .red { color: var(--red); } .green { color: var(--green); }

        /* LISTS & CARDS */
        h2 { font-size: 0.75rem; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin: 30px 0 15px 10px; display: flex; align-items: center; gap: 10px; }
        h2::after { content: ''; flex: 1; height: 1px; background: var(--glass-border); }

        .card {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 16px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card.dim { opacity: 0.3; }

        .checkbox {
            width: 24px; height: 24px; border-radius: 50%; border: 1.5px solid var(--gold);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .checkbox.checked { background: var(--gold); box-shadow: 0 0 15px var(--gold); }

        /* INPUTS */
        .liquid-btn {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), transparent);
            border: 1px solid var(--gold); color: var(--gold); padding: 12px;
            border-radius: 12px; width: 100%; font-family: var(--font); font-weight: bold;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.2s;
        }
        .liquid-btn:active { transform: scale(0.98); background: var(--gold); color: #000; }
        
        .form-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: #fff; padding: 12px; border-radius: 10px; margin: 5px 0 15px 0; box-sizing: border-box; font-family: var(--font);
        }

        /* MODAL SYSTEM - ENGINEERED FOR NO-CRASH */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal { width: 90%; max-width: 420px; padding: 25px; pointer-events: auto; max-height: 85vh; overflow-y: auto; }

        /* NAVIGATION */
        .nav-bar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 85%; height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item { color: var(--silver); font-size: 0.65rem; text-decoration: none; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--gold); }

        .view-pane { display: none; }
        .view-pane.active { display: block; }
    </style>
</head>
<body>

    <div id="view-dashboard" class="view-pane active">
        <div class="glass-panel hud-grid">
            <div class="hud-cell">
                <div class="stat-label">Gross Intake</div>
                <div id="hud-gross" class="stat-val">$0</div>
            </div>
            <div class="hud-cell">
                <div class="stat-label">Trade Extraction</div>
                <div id="hud-trade" class="stat-val gold">$0</div>
            </div>
            <div class="hud-cell">
                <div class="stat-label">Escrow / Diversion</div>
                <div id="hud-escrow" class="stat-val red">$0</div>
            </div>
            <div class="hud-cell">
                <div class="stat-label">Burn Rate (Day)</div>
                <div id="hud-burn" class="stat-val red">$0</div>
            </div>
            <div class="hud-cell full">
                <div class="stat-label" id="cycle-label">Liquid Surplus</div>
                <div id="hud-surplus" class="stat-val gold" style="font-size: 1.8rem;">$0</div>
            </div>
        </div>
        <div id="ledger-content"></div>
    </div>

    <div id="view-settings" class="view-pane">
        <div class="glass-panel" style="padding: 20px;">
            <h2>Income Streams</h2>
            <div id="income-config-list"></div>
            <button class="liquid-btn" style="padding:8px; font-size:0.6rem;" onclick="addIncome()">+ Add Stream</button>

            <h2>Distribution Rules (Smart Escrow)</h2>
            <div id="rule-config-list"></div>
            <button class="liquid-btn" style="padding:8px; font-size:0.6rem;" onclick="addRule()">+ Add Distribution Gate</button>

            <h2>Matrix Configuration</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <div class="stat-label">Cycle</div>
                    <select id="cycle-divisor" class="form-input" onchange="updateGlobalConfig()">
                        <option value="4">Weekly</option>
                        <option value="2">Bi-Weekly</option>
                    </select>
                </div>
                <div>
                    <div class="stat-label">Trading Extraction</div>
                    <input type="number" id="trading-out" class="form-input" onchange="updateGlobalConfig()">
                </div>
            </div>
            
            <h2>Category & Templates</h2>
            <button class="liquid-btn" onclick="openModal('templates')" style="background:rgba(255,255,255,0.05); margin-bottom:10px;">Browse Bill Templates</button>
            <div id="cat-config-list"></div>
            <input type="text" id="new-cat-input" class="form-input" placeholder="New Category..." onkeydown="if(event.key==='Enter') addCategory()">
        </div>
        <button class="liquid-btn" onclick="openModal('add_bill')">+ Add Custom Ledger Item</button>
        <button class="liquid-btn" style="border-color: #333; color: #555; margin-top:20px;" onclick="factoryReset()">Purge System</button>
    </div>

    <div class="nav-bar glass-panel">
        <a href="#" class="nav-item active" onclick="switchView('dashboard', this)"><span>üìä</span>Ledger</a>
        <a href="#" class="nav-item" onclick="resetCycle()"><span>üîÑ</span>Reset</a>
        <a href="#" class="nav-item" onclick="switchView('settings', this)"><span>‚öôÔ∏è</span>Matrix</a>
    </div>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()">
        <div class="modal glass-panel" id="modal-content" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        // SMART TEMPLATES
        const templates = [
            { name: "Rent/Mortgage", amount: 1200, cat: "Fixed" },
            { name: "Car Insurance", amount: 180, cat: "Fixed" },
            { name: "Electric Bill", amount: 160, cat: "Utility" },
            { name: "Internet", amount: 85, cat: "Utility" },
            { name: "Gym Membership", amount: 45, cat: "Lifestyle" }
        ];

        // PERSISTENT STATE
        let state = JSON.parse(localStorage.getItem('sfti_ibt_v8')) || {
            incomes: [{ id: 1, name: 'Daniel', amount: 3600 }, { id: 2, name: 'Katlynn', amount: 1100 }],
            rules: [
                { id: 1, name: 'Trading Escrow', type: 'percent', value: 5, target: 'total' },
                { id: 2, name: 'Car Escrow (Bills Acc)', type: 'percent', value: 5, target: 'total' }
            ],
            bills: [],
            categories: ["Fixed", "Utility", "Lifestyle", "Debt"],
            config: { divisor: 4, tradeOut: 0 }
        };

        function init() {
            render();
            renderSettings();
            startSentinel();
        }

        // CALCULATE SMART HUD
        function calculate() {
            const grossMonthly = state.incomes.reduce((s, i) => s + Number(i.amount), 0);
            
            // Process Rules
            let totalDiverted = 0;
            state.rules.forEach(rule => {
                if(rule.type === 'percent') totalDiverted += (grossMonthly * (rule.value / 100));
                else totalDiverted += Number(rule.value);
            });

            const totalBills = state.bills.reduce((s, b) => s + Number(b.amount), 0);
            const unpaidBills = state.bills.filter(b => !b.paid).reduce((s, b) => s + Number(b.amount), 0);
            
            const tradeOut = Number(state.config.tradeOut);
            const div = Number(state.config.divisor);
            
            const surplus = ((grossMonthly + tradeOut - totalDiverted) / div) - (unpaidBills / div);
            const burn = totalBills / 30;

            document.getElementById('hud-gross').innerText = `$${Math.round(grossMonthly).toLocaleString()}`;
            document.getElementById('hud-trade').innerText = `+$${Math.round(tradeOut).toLocaleString()}`;
            document.getElementById('hud-escrow').innerText = `-$${Math.round(totalDiverted).toLocaleString()}`;
            document.getElementById('hud-burn').innerText = `$${Math.round(burn).toLocaleString()}`;
            document.getElementById('hud-surplus').innerText = `$${Math.round(surplus).toLocaleString()}`;
            document.getElementById('cycle-label').innerText = div === 4 ? "Weekly Surplus" : "Bi-Weekly Surplus";
        }

        function render() {
            const container = document.getElementById('ledger-content');
            container.innerHTML = '';
            
            state.categories.forEach(cat => {
                const items = state.bills.filter(b => b.cat === cat);
                if(items.length === 0) return;

                container.innerHTML += `<h2>${cat}</h2>`;
                items.forEach(bill => {
                    container.innerHTML += `
                        <div class="card ${bill.paid ? 'dim' : ''}" onclick="editBill(${bill.id})">
                            <div>
                                <div style="font-weight:bold; font-size:0.9rem;">${bill.name}</div>
                                <div style="font-size:0.7rem; color:var(--silver);">$${bill.amount}</div>
                            </div>
                            <div class="checkbox ${bill.paid ? 'checked' : ''}" onclick="event.stopPropagation(); togglePaid(${bill.id})"></div>
                        </div>`;
                });
            });
            calculate();
            localStorage.setItem('sfti_ibt_v8', JSON.stringify(state));
        }

        // SETTINGS RENDERING
        function renderSettings() {
            document.getElementById('trading-out').value = state.config.tradeOut;
            document.getElementById('cycle-divisor').value = state.config.divisor;

            // Render Income Streams
            const incList = document.getElementById('income-config-list');
            incList.innerHTML = '';
            state.incomes.forEach(inc => {
                incList.innerHTML += `
                    <div style="display:flex; gap:8px; margin-bottom:5px;">
                        <input type="text" class="form-input" style="flex:2;" value="${inc.name}" onchange="updateIncome(${inc.id}, 'name', this.value)">
                        <input type="number" class="form-input" style="flex:1;" value="${inc.amount}" onchange="updateIncome(${inc.id}, 'amount', this.value)">
                        <button style="background:none; border:none; color:var(--red);" onclick="removeIncome(${inc.id})">√ó</button>
                    </div>`;
            });

            // Render Distribution Rules
            const ruleList = document.getElementById('rule-config-list');
            ruleList.innerHTML = '';
            state.rules.forEach(rule => {
                ruleList.innerHTML += `
                    <div style="display:flex; gap:8px; margin-bottom:5px; align-items:center;">
                        <input type="text" class="form-input" style="flex:2;" value="${rule.name}" onchange="updateRule(${rule.id}, 'name', this.value)">
                        <input type="number" class="form-input" style="flex:1;" value="${rule.value}" onchange="updateRule(${rule.id}, 'value', this.value)">
                        <select class="form-input" style="flex:1;" onchange="updateRule(${rule.id}, 'type', this.value)">
                            <option value="percent" ${rule.type==='percent'?'selected':''}>%</option>
                            <option value="fixed" ${rule.type==='fixed'?'selected':''}>$</option>
                        </select>
                        <button style="background:none; border:none; color:var(--red);" onclick="removeRule(${rule.id})">√ó</button>
                    </div>`;
            });

            // Render Categories
            const catList = document.getElementById('cat-config-list');
            catList.innerHTML = '';
            state.categories.forEach(c => {
                catList.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--glass-border);">
                        <span>${c}</span><span style="color:var(--red); cursor:pointer;" onclick="removeCategory('${c}')">Remove</span>
                    </div>`;
            });
        }

        // ACTION HANDLERS
        function updateGlobalConfig() {
            state.config.divisor = document.getElementById('cycle-divisor').value;
            state.config.tradeOut = document.getElementById('trading-out').value;
            render();
        }

        function togglePaid(id) { 
            const b = state.bills.find(x => x.id === id); 
            b.paid = !b.paid; 
            render(); 
        }

        function addIncome() { state.incomes.push({ id: Date.now(), name: 'New Stream', amount: 0 }); renderSettings(); render(); }
        function updateIncome(id, key, val) { state.incomes.find(x => x.id === id)[key] = val; render(); }
        function removeIncome(id) { state.incomes = state.incomes.filter(x => x.id !== id); renderSettings(); render(); }

        function addRule() { state.rules.push({ id: Date.now(), name: 'New Rule', type: 'percent', value: 0 }); renderSettings(); render(); }
        function updateRule(id, key, val) { state.rules.find(x => x.id === id)[key] = val; render(); }
        function removeRule(id) { state.rules = state.rules.filter(x => x.id !== id); renderSettings(); render(); }

        function addCategory() { 
            const val = document.getElementById('new-cat-input').value; 
            if(val) { state.categories.push(val); document.getElementById('new-cat-input').value = ''; renderSettings(); render(); }
        }
        function removeCategory(c) { state.categories = state.categories.filter(x => x !== c); renderSettings(); render(); }

        // MODAL LOGIC
        function openModal(type, data = null) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.style.display = 'flex';
            
            if(type === 'templates') {
                content.innerHTML = `<h3>Templates</h3><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">` + 
                    templates.map(t => `<button class="liquid-btn" style="font-size:0.6rem;" onclick='addFromTemplate(${JSON.stringify(t)})'>${t.name}</button>`).join('') + 
                    `</div><button class="liquid-btn" style="margin-top:20px; border-color:#444;" onclick="closeModal()">Close</button>`;
            } else {
                const b = data || { name: '', amount: '', cat: state.categories[0] };
                content.innerHTML = `
                    <h3>${data ? 'Adjust Entry' : 'New Entry'}</h3>
                    <input type="text" id="m-name" class="form-input" value="${b.name}" placeholder="Description">
                    <input type="number" id="m-amount" class="form-input" value="${b.amount}" placeholder="Amount">
                    <select id="m-cat" class="form-input">` + state.categories.map(c => `<option value="${c}" ${b.cat===c?'selected':''}>${c}</option>`).join('') + `</select>
                    <button class="liquid-btn" onclick="saveBill(${b.id || 'null'})">Commit</button>
                    ${data ? `<button class="liquid-btn" style="color:var(--red); border-color:var(--red);" onclick="deleteBill(${b.id})">Delete</button>` : ''}
                    <button class="liquid-btn" style="border-color:#444; margin-top:10px;" onclick="closeModal()">Back</button>`;
            }
        }

        function saveBill(id) {
            const b = { name: document.getElementById('m-name').value, amount: document.getElementById('m-amount').value, cat: document.getElementById('m-cat').value, paid: false };
            if(id === null) { b.id = Date.now(); state.bills.push(b); }
            else { Object.assign(state.bills.find(x => x.id === id), b); }
            closeModal(); render();
        }

        function addFromTemplate(t) { state.bills.push({...t, id: Date.now(), paid: false}); closeModal(); render(); }
        function editBill(id) { openModal('edit', state.bills.find(x => x.id === id)); }
        function deleteBill(id) { state.bills = state.bills.filter(x => x.id !== id); closeModal(); render(); }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        // TIME-AWARE SENTINEL
        function startSentinel() {
            setInterval(() => {
                const now = new Date();
                if(now.getDay() === 1 && now.getHours() === 9 && now.getMinutes() === 0) {
                    new Notification("SFT.iBT Sentinel", { body: "New cycle active. Update Trading Extractions." });
                }
            }, 60000);
        }

        function switchView(v, el) {
            document.querySelectorAll('.view-pane').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function resetCycle() { if(confirm("Reset checkmarks?")) { state.bills.forEach(b => b.paid = false); render(); } }
        function factoryReset() { if(confirm("Wipe all data?")) { localStorage.removeItem('sfti_ibt_v8'); location.reload(); } }

        window.onload = init;
    </script>
</body>
</html>
